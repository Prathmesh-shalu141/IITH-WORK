#include "gpio.h"
#include "pwm.h"
#include "timer.h"
#include <stdint.h>
#include <stdbool.h>
#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include "demo_system.h"
#include "func.h"
#define USE_GPIO_SHIFT_REG 0

#define IMG_SIZE 50
#define KERNEL_SIZE 7


double snr;
  uint32_t image[IMG_SIZE][IMG_SIZE]= {
    {158, 156, 153, 159, 175, 148, 95, 102, 106, 105, 113, 123, 127, 130, 129, 132, 134, 132, 132, 133, 132, 130, 130, 132, 132, 131, 129, 129, 128, 127, 113, 115, 152, 156, 153, 154, 152, 155, 151, 179, 222, 134, 109, 123, 121, 123, 122, 125, 128, 108},
    {156, 156, 154, 163, 169, 142, 94, 99, 106, 103, 112, 122, 127, 130, 131, 130, 133, 132, 132, 131, 132, 130, 129, 133, 132, 131, 129, 128, 128, 128, 118, 106, 136, 160, 160, 159, 156, 154, 151, 152, 211, 192, 107, 119, 122, 123, 125, 135, 87, 41},
    {157, 157, 160, 165, 162, 144, 93, 100, 106, 103, 111, 122, 127, 128, 129, 130, 131, 129, 131, 130, 125, 128, 128, 130, 131, 131, 128, 126, 126, 127, 121, 106, 126, 159, 162, 160, 158, 155, 154, 145, 169, 228, 148, 107, 124, 122, 135, 85, 40, 50},
    {159, 162, 168, 162, 161, 143, 90, 100, 105, 103, 111, 121, 124, 126, 126, 129, 129, 130, 130, 126, 120, 120, 117, 119, 127, 131, 129, 127, 126, 127, 119, 110, 125, 151, 158, 157, 156, 155, 156, 151, 142, 203, 214, 113, 114, 133, 80, 40, 55, 49},
    {160, 166, 155, 156, 164, 142, 89, 99, 105, 103, 112, 120, 124, 125, 127, 128, 127, 129, 128, 133, 136, 149, 156, 147, 134, 119, 125, 130, 126, 125, 119, 109, 121, 145, 151, 155, 153, 154, 151, 146, 138, 160, 230, 168, 110, 83, 39, 58, 52, 45},
    {166, 158, 129, 158, 167, 145, 87, 94, 102, 103, 112, 120, 124, 125, 127, 129, 135, 129, 136, 144, 153, 169, 179, 183, 189, 172, 128, 118, 127, 123, 115, 107, 121, 145, 146, 152, 150, 146, 145, 141, 141, 137, 187, 239, 106, 33, 55, 51, 48, 47},
    {173, 127, 105, 164, 167, 143, 83, 90, 99, 100, 108, 116, 120, 122, 126, 126, 123, 123, 130, 133, 141, 157, 172, 181, 187, 199, 194, 142, 103, 116, 113, 104, 120, 150, 145, 142, 147, 142, 144, 142, 143, 139, 160, 185, 51, 46, 54, 47, 50, 42},
    {157, 91, 105, 165, 168, 141, 81, 92, 100, 101, 108, 114, 118, 121, 129, 113, 114, 122, 127, 134, 135, 149, 171, 186, 188, 189, 197, 210, 177, 100, 106, 101, 119, 155, 153, 121, 128, 148, 144, 142, 143, 149, 145, 51, 42, 51, 48, 51, 53, 91},
    {117, 81, 111, 163, 168, 140, 84, 92, 100, 101, 108, 115, 120, 124, 113, 111, 119, 118, 126, 136, 139, 146, 169, 179, 185, 201, 206, 206, 229, 166, 77, 96, 116, 152, 157, 111, 77, 144, 146, 143, 143, 155, 79, 39, 55, 49, 50, 56, 98, 150},
    {90, 87, 109, 160, 167, 140, 82, 93, 100, 100, 107, 116, 120, 119, 110, 115, 115, 122, 133, 140, 142, 140, 158, 183, 202, 202, 199, 202, 206, 222, 149, 73, 117, 153, 157, 118, 46, 115, 149, 137, 155, 112, 36, 56, 48, 51, 48, 88, 147, 156},
    {92, 88, 108, 158, 165, 141, 83, 90, 100, 101, 108, 111, 129, 113, 109, 114, 120, 134, 138, 139, 124, 146, 184, 194, 190, 197, 204, 204, 205, 204, 231, 129, 97, 155, 156, 121, 47, 49, 136, 157, 135, 51, 47, 54, 51, 46, 66, 140, 153, 164},
    {91, 87, 106, 159, 166, 142, 80, 88, 97, 98, 107, 109, 150, 107, 110, 116, 126, 131, 132, 122, 149, 181, 181, 182, 193, 195, 197, 201, 203, 204, 212, 204, 101, 150, 159, 119, 33, 87, 194, 228, 153, 34, 57, 51, 52, 51, 126, 153, 160, 158},
    {95, 93, 107, 158, 169, 143, 80, 89, 101, 101, 105, 121, 160, 98, 109, 120, 124, 126, 121, 151, 172, 171, 178, 185, 183, 186, 195, 198, 198, 198, 202, 213, 170, 144, 155, 107, 123, 207, 209, 217, 188, 42, 50, 49, 40, 97, 157, 156, 157, 156},
    {101, 97, 113, 158, 173, 147, 83, 93, 102, 102, 102, 128, 158, 96, 107, 115, 121, 121, 144, 150, 159, 174, 176, 174, 175, 182, 186, 191, 183, 190, 198, 195, 205, 167, 158, 186, 210, 204, 200, 221, 170, 40, 50, 47, 64, 144, 157, 158, 155, 153},
    {100, 96, 113, 161, 176, 149, 82, 91, 100, 100, 96, 135, 169, 109, 107, 114, 120, 142, 142, 144, 156, 166, 167, 170, 175, 172, 179, 179, 185, 188, 183, 179, 177, 189, 200, 204, 198, 202, 191, 221, 133, 34, 51, 48, 122, 157, 160, 158, 156, 155},
    {98, 93, 111, 163, 174, 148, 85, 92, 100, 100, 93, 139, 175, 131, 102, 113, 136, 134, 140, 146, 147, 159, 168, 167, 168, 163, 166, 176, 180, 172, 168, 174, 191, 197, 196, 196, 201, 202, 162, 181, 79, 43, 44, 83, 150, 157, 160, 158, 157, 158},
    {97, 94, 115, 163, 175, 151, 84, 92, 98, 100, 87, 146, 188, 147, 115, 128, 129, 135, 137, 137, 148, 143, 139, 144, 146, 160, 165, 158, 150, 162, 180, 194, 193, 193, 197, 206, 219, 168, 133, 159, 41, 51, 54, 130, 156, 158, 156, 156, 156, 156},
    {99, 98, 121, 164, 177, 153, 82, 90, 100, 102, 87, 142, 200, 142, 125, 116, 130, 133, 129, 137, 137, 124, 92, 117, 115, 96, 82, 57, 128, 189, 196, 195, 191, 202, 210, 187, 140, 96, 159, 95, 39, 45, 79, 153, 158, 159, 156, 154, 154, 153},
    {103, 98, 120, 163, 175, 153, 84, 90, 99, 101, 92, 116, 204, 144, 124, 122, 130, 126, 133, 133, 111, 88, 62, 84, 85, 73, 51, 111, 181, 190, 190, 189, 198, 188, 151, 113, 117, 174, 98, 40, 51, 49, 120, 160, 163, 160, 157, 155, 154, 153},
    {106, 99, 116, 163, 175, 154, 85, 89, 99, 97, 101, 98, 185, 175, 123, 126, 121, 127, 121, 94, 70, 55, 63, 68, 80, 71, 129, 193, 185, 178, 178, 193, 164, 91, 110, 160, 187, 95, 37, 57, 44, 69, 144, 163, 164, 162, 158, 156, 155, 152},
    {107, 98, 108, 162, 176, 155, 83, 87, 98, 96, 105, 98, 140, 198, 122, 118, 128, 125, 85, 72, 62, 72, 61, 53, 67, 114, 175, 184, 175, 173, 183, 195, 176, 86, 101, 151, 76, 33, 59, 50, 45, 98, 149, 169, 162, 162, 161, 159, 156, 153},
    {105, 97, 105, 161, 176, 157, 84, 88, 101, 99, 106, 107, 135, 180, 105, 121, 122, 85, 53, 55, 68, 77, 64, 43, 119, 155, 184, 168, 167, 175, 196, 201, 208, 104, 59, 133, 47, 52, 59, 45, 58, 129, 151, 159, 161, 161, 163, 159, 157, 153},
    {104, 96, 105, 160, 177, 157, 88, 91, 104, 100, 110, 117, 121, 148, 116, 125, 72, 53, 59, 52, 56, 79, 61, 115, 180, 166, 180, 163, 163, 187, 199, 203, 216, 142, 41, 122, 64, 55, 59, 42, 84, 151, 159, 153, 151, 150, 154, 156, 155, 153},
    {101, 95, 103, 160, 178, 157, 87, 91, 103, 101, 109, 118, 119, 113, 137, 88, 60, 59, 62, 49, 68, 52, 99, 165, 180, 176, 145, 157, 178, 184, 195, 199, 222, 165, 38, 107, 76, 56, 55, 49, 116, 157, 162, 162, 161, 152, 146, 144, 145, 147},
    {103, 98, 104, 161, 180, 159, 88, 91, 103, 100, 103, 130, 133, 88, 102, 70, 75, 57, 59, 49, 58, 75, 163, 186, 169, 131, 109, 96, 136, 172, 189, 196, 142, 104, 48, 96, 92, 55, 50, 64, 136, 158, 157, 156, 158, 156, 154, 154, 146, 137},
    {100, 91, 96, 161, 180, 159, 85, 89, 103, 91, 126, 161, 136, 73, 65, 86, 63, 56, 57, 61, 41, 134, 198, 168, 66, 48, 89, 86, 115, 151, 201, 112, 71, 69, 42, 87, 100, 53, 43, 86, 152, 157, 153, 154, 154, 153, 152, 151, 140, 133},
    {101, 88, 90, 161, 183, 160, 90, 98, 104, 77, 141, 155, 65, 62, 67, 98, 75, 46, 55, 36, 88, 180, 181, 122, 95, 92, 164, 155, 109, 152, 192, 96, 130, 78, 36, 92, 112, 51, 46, 114, 158, 154, 152, 153, 152, 150, 145, 135, 140, 161},
    {101, 83, 84, 160, 184, 164, 93, 99, 111, 128, 112, 53, 90, 80, 68, 111, 96, 42, 46, 50, 153, 181, 114, 143, 157, 144, 151, 158, 129, 142, 201, 158, 121, 90, 47, 93, 117, 42, 61, 135, 156, 152, 151, 151, 149, 142, 135, 165, 188, 192},
    {89, 74, 77, 158, 184, 164, 91, 97, 129, 116, 68, 76, 104, 52, 59, 90, 92, 60, 37, 106, 186, 93, 115, 148, 166, 176, 176, 161, 138, 135, 203, 169, 139, 114, 51, 85, 118, 35, 79, 150, 155, 151, 150, 148, 144, 133, 169, 201, 192, 193},
    {77, 67, 74, 158, 179, 160, 91, 103, 116, 93, 81, 82, 92, 48, 50, 51, 102, 93, 41, 173, 116, 58, 129, 139, 158, 174, 173, 154, 134, 128, 196, 171, 143, 105, 50, 75, 124, 40, 104, 162, 155, 150, 146, 145, 136, 151, 197, 192, 201, 204},
    {80, 63, 65, 156, 179, 162, 89, 114, 109, 93, 84, 94, 103, 50, 50, 89, 108, 56, 104, 154, 41, 77, 120, 137, 149, 159, 165, 142, 128, 126, 189, 172, 139, 83, 52, 65, 127, 51, 128, 159, 152, 150, 148, 144, 136, 184, 196, 202, 208, 206},
    {81, 66, 76, 158, 178, 164, 95, 100, 95, 85, 82, 86, 113, 61, 53, 72, 53, 72, 178, 65, 45, 92, 118, 133, 145, 152, 158, 143, 120, 109, 163, 163, 128, 55, 58, 54, 123, 81, 146, 156, 150, 149, 148, 139, 150, 197, 200, 207, 207, 208},
    {79, 68, 99, 162, 175, 168, 89, 99, 100, 76, 71, 77, 114, 95, 74, 56, 125, 135, 97, 42, 61, 100, 121, 132, 141, 147, 158, 154, 144, 166, 186, 155, 99, 42, 73, 54, 109, 119, 152, 154, 150, 148, 146, 135, 164, 201, 206, 207, 209, 210},
    {69, 63, 98, 163, 177, 168, 89, 107, 95, 76, 60, 79, 83, 112, 74, 137, 156, 96, 48, 56, 58, 88, 119, 133, 140, 138, 137, 142, 145, 174, 169, 140, 62, 47, 78, 54, 98, 137, 152, 152, 148, 147, 145, 133, 171, 209, 208, 207, 211, 213},
    {59, 61, 102, 166, 181, 167, 104, 110, 89, 53, 70, 103, 90, 87, 125, 173, 125, 58, 47, 57, 61, 76, 109, 126, 136, 141, 115, 118, 131, 141, 135, 105, 41, 54, 75, 59, 89, 153, 152, 152, 149, 146, 145, 132, 181, 214, 209, 211, 213, 210},
    {52, 56, 102, 161, 181, 168, 95, 106, 85, 59, 77, 121, 94, 101, 133, 164, 84, 49, 52, 56, 61, 65, 87, 115, 127, 140, 138, 127, 136, 147, 143, 58, 47, 55, 78, 63, 92, 157, 152, 154, 152, 147, 144, 127, 190, 218, 213, 212, 206, 206},
    {48, 61, 111, 155, 180, 166, 89, 88, 73, 56, 71, 103, 116, 107, 117, 111, 42, 56, 52, 51, 55, 58, 64, 82, 118, 134, 143, 155, 162, 162, 96, 44, 59, 54, 86, 69, 92, 160, 155, 153, 151, 147, 141, 124, 198, 219, 212, 211, 216, 212},
    {43, 52, 106, 159, 178, 162, 105, 85, 66, 61, 63, 102, 87, 126, 133, 79, 46, 62, 53, 50, 52, 59, 61, 61, 90, 118, 138, 158, 166, 158, 82, 42, 55, 60, 90, 77, 100, 146, 131, 143, 148, 148, 137, 132, 211, 212, 211, 209, 149, 87},
    {67, 46, 78, 152, 175, 166, 118, 76, 56, 63, 63, 105, 100, 111, 107, 128, 76, 58, 56, 51, 50, 57, 55, 93, 126, 130, 139, 146, 147, 175, 189, 141, 67, 44, 93, 75, 105, 135, 117, 115, 113, 119, 115, 134, 210, 207, 210, 126, 44, 66},
    {136, 95, 59, 143, 176, 165, 128, 53, 54, 82, 76, 72, 101, 84, 121, 118, 94, 60, 58, 52, 54, 60, 59, 87, 125, 129, 140, 138, 152, 179, 195, 211, 204, 102, 65, 68, 103, 152, 141, 133, 119, 103, 103, 124, 210, 213, 126, 59, 87, 93},
    {127, 152, 72, 143, 180, 172, 128, 40, 57, 62, 66, 60, 72, 72, 112, 128, 111, 78, 55, 55, 56, 66, 81, 84, 128, 135, 140, 143, 158, 169, 179, 188, 207, 222, 98, 44, 112, 151, 143, 142, 137, 129, 119, 163, 223, 183, 74, 95, 104, 95},
    {77, 170, 79, 138, 184, 171, 106, 43, 50, 55, 78, 49, 67, 88, 89, 133, 97, 106, 50, 58, 51, 63, 95, 82, 133, 135, 139, 145, 152, 163, 175, 187, 198, 219, 195, 38, 117, 153, 143, 139, 135, 124, 153, 203, 221, 136, 87, 109, 95, 101},
    {59, 166, 79, 135, 184, 173, 100, 45, 43, 73, 72, 50, 49, 70, 93, 127, 127, 104, 56, 60, 48, 85, 108, 88, 135, 137, 137, 142, 149, 159, 170, 185, 200, 208, 227, 85, 117, 152, 142, 138, 128, 132, 206, 218, 198, 102, 102, 104, 97, 97},
    {50, 163, 89, 133, 183, 171, 99, 39, 53, 62, 60, 51, 52, 59, 92, 125, 89, 73, 80, 65, 52, 113, 108, 97, 139, 139, 136, 138, 145, 155, 165, 179, 196, 204, 225, 144, 125, 153, 139, 138, 126, 142, 209, 216, 161, 101, 102, 95, 99, 90},
    {42, 152, 103, 130, 183, 172, 109, 44, 56, 53, 60, 54, 53, 71, 83, 88, 104, 64, 49, 48, 70, 126, 94, 115, 143, 141, 138, 137, 143, 151, 159, 173, 191, 203, 215, 195, 122, 127, 143, 146, 142, 137, 167, 215, 133, 95, 87, 97, 95, 90},
    {32, 148, 118, 124, 182, 171, 105, 48, 49, 55, 61, 53, 46, 72, 102, 73, 81, 55, 42, 46, 103, 114, 82, 135, 140, 142, 140, 136, 141, 148, 156, 166, 184, 200, 210, 217, 106, 77, 89, 92, 122, 146, 178, 199, 89, 81, 93, 95, 97, 69},
    {71, 154, 137, 124, 183, 170, 99, 47, 52, 51, 57, 56, 48, 50, 96, 120, 60, 41, 42, 78, 115, 71, 113, 140, 138, 141, 142, 138, 137, 143, 151, 161, 177, 195, 205, 221, 143, 94, 91, 53, 56, 182, 206, 119, 54, 89, 93, 89, 98, 62},
    {91, 154, 142, 126, 183, 174, 90, 45, 55, 50, 60, 71, 58, 63, 70, 99, 54, 40, 49, 81, 79, 103, 133, 136, 139, 141, 143, 143, 139, 140, 147, 157, 169, 186, 200, 219, 175, 91, 106, 90, 91, 182, 120, 57, 82, 95, 73, 107, 88, 63},
    {55, 135, 162, 128, 183, 172, 71, 46, 57, 59, 58, 81, 84, 65, 76, 98, 53, 44, 70, 97, 118, 130, 129, 134, 138, 140, 144, 146, 144, 143, 146, 153, 164, 179, 193, 211, 201, 92, 103, 113, 116, 106, 91, 88, 93, 71, 94, 113, 68, 53},
    {39, 132, 194, 134, 183, 166, 62, 49, 63, 67, 74, 79, 92, 75, 63, 76, 72, 63, 105, 122, 124, 127, 131, 133, 136, 138, 142, 145, 147, 149, 149, 153, 163, 173, 189, 201, 214, 117, 91, 120, 121, 121, 115, 89, 81, 86, 124, 81, 50, 78},
};

      
      




uint32_t gaussKernel[KERNEL_SIZE][KERNEL_SIZE] = {
    {1,   4,   7,  10,   7,   4,  1},
    {4,  12,  26,  33,  26,  12,  4},
    {7,  26,  55,  71,  55,  26,  7},
    {10, 33,  71,  91,  71,  33, 10},
    {7,  26,  55,  71,  55,  26,  7},
    {4,  12,  26,  33,  26,  12,  4},
    {1,   4,   7,  10,   7,   4,  1}
};


 

uint64_t op_exact[IMG_SIZE][IMG_SIZE];
uint64_t op_func[IMG_SIZE][IMG_SIZE];


void test_uart_irq_handler(void) __attribute__((interrupt));

void test_uart_irq_handler(void) {
    int uart_in_char;
    while ((uart_in_char = uart_in(DEFAULT_UART)) != -1) {
        uart_out(DEFAULT_UART, uart_in_char);
        uart_out(DEFAULT_UART, '\r');
        uart_out(DEFAULT_UART, '\n');
    }
}
void pcount_reset() {
  asm volatile(
      "csrw minstret,       x0\n"
      "csrw mcycle,         x0\n"
      "csrw mhpmcounter3,   x0\n"
      "csrw mhpmcounter4,   x0\n"
      "csrw mhpmcounter5,   x0\n"
      "csrw mhpmcounter6,   x0\n"
      "csrw mhpmcounter7,   x0\n"
      "csrw mhpmcounter8,   x0\n"
      "csrw mhpmcounter9,   x0\n"
      "csrw mhpmcounter10,  x0\n"
      "csrw mhpmcounter11,  x0\n"
      "csrw mhpmcounter12,  x0\n"
      "csrw mhpmcounter13,  x0\n"
      "csrw mhpmcounter14,  x0\n"
      "csrw mhpmcounter15,  x0\n"
      "csrw mhpmcounter16,  x0\n"
      "csrw mhpmcounter17,  x0\n"
      "csrw mhpmcounter18,  x0\n"
      "csrw mhpmcounter19,  x0\n"
      "csrw mhpmcounter20,  x0\n"
      "csrw mhpmcounter21,  x0\n"
      "csrw mhpmcounter22,  x0\n"
      "csrw mhpmcounter23,  x0\n"
      "csrw mhpmcounter24,  x0\n"
      "csrw mhpmcounter25,  x0\n"
      "csrw mhpmcounter26,  x0\n"
      "csrw mhpmcounter27,  x0\n"
      "csrw mhpmcounter28,  x0\n"
      "csrw mhpmcounter29,  x0\n"
      "csrw mhpmcounter30,  x0\n"
      "csrw mhpmcounter31,  x0\n"
      "csrw minstreth,      x0\n"
      "csrw mcycleh,        x0\n"
      "csrw mhpmcounter3h,  x0\n"
      "csrw mhpmcounter4h,  x0\n"
      "csrw mhpmcounter5h,  x0\n"
      "csrw mhpmcounter6h,  x0\n"
      "csrw mhpmcounter7h,  x0\n"
      "csrw mhpmcounter8h,  x0\n"
      "csrw mhpmcounter9h,  x0\n"
      "csrw mhpmcounter10h, x0\n"
      "csrw mhpmcounter11h, x0\n"
      "csrw mhpmcounter12h, x0\n"
      "csrw mhpmcounter13h, x0\n"
      "csrw mhpmcounter14h, x0\n"
      "csrw mhpmcounter15h, x0\n"
      "csrw mhpmcounter16h, x0\n"
      "csrw mhpmcounter17h, x0\n"
      "csrw mhpmcounter18h, x0\n"
      "csrw mhpmcounter19h, x0\n"
      "csrw mhpmcounter20h, x0\n"
      "csrw mhpmcounter21h, x0\n"
      "csrw mhpmcounter22h, x0\n"
      "csrw mhpmcounter23h, x0\n"
      "csrw mhpmcounter24h, x0\n"
      "csrw mhpmcounter25h, x0\n"
      "csrw mhpmcounter26h, x0\n"
      "csrw mhpmcounter27h, x0\n"
      "csrw mhpmcounter28h, x0\n"
      "csrw mhpmcounter29h, x0\n"
      "csrw mhpmcounter30h, x0\n"
      "csrw mhpmcounter31h, x0\n");
}
static inline void pcount_enable(int enable) {
  unsigned int inhibit_val = enable ? 0x0 : 0xFFFFFFFF;
  asm volatile("csrw  0x320, %0\n" : : "r"(inhibit_val));
}


void gaussian_filter_exact() {
    int offset = KERNEL_SIZE / 2;
    for (unsigned int i = 0; i < IMG_SIZE; i++) {
        for (unsigned int j = 0; j < IMG_SIZE; j++) {
            uint64_t exact = 0;
            for (unsigned int ki = 0; ki < KERNEL_SIZE; ki++) {
                for (unsigned int kj = 0; kj < KERNEL_SIZE; kj++) {
                    int x = i + ki - offset;
                    int y = j + kj - offset;

                    // Zero padding condition
                    if (x >= 0 && x < IMG_SIZE && y >= 0 && y < IMG_SIZE) {
                       // exact += image[x][y] * gaussKernel[ki][kj];
                       exact +=mult_exact_c(
                                    image[x][y],
                                    gaussKernel[ki][kj]
                                  );
                    }
                }
            }
            op_exact[i][j] = exact >>10;  // normalization
        }
    }
}

// Approximate Gaussian filter with zero padding
void gaussian_filter_approx() {
    int offset = KERNEL_SIZE / 2;
    for (unsigned int i = 0; i < IMG_SIZE; i++) {
        for (unsigned int j = 0; j < IMG_SIZE; j++) {
            uint64_t approx = 0;
            for (unsigned int ki = 0; ki < KERNEL_SIZE; ki++) {
                for (unsigned int kj = 0; kj < KERNEL_SIZE; kj++) {
                    int x = i + ki - offset;
                    int y = j + kj - offset;

                    // Zero padding condition
                    if (x >= 0 && x < IMG_SIZE && y >= 0 && y < IMG_SIZE) {
                        approx += mult_downroba2_c(
                                    image[x][y],
                                    gaussKernel[ki][kj]
                                  );
                    }
                }
            }
            op_func[i][j] = approx >> 10;  // normalization
        }
    }
}



double compute_snr(uint64_t op_exact[IMG_SIZE][IMG_SIZE], uint64_t op_func[IMG_SIZE][IMG_SIZE]) {
    double signal = 0.0;
    double noise = 0.0;

    for (unsigned int i = 0; i < IMG_SIZE; i++) {
        for (unsigned int j = 0; j < IMG_SIZE; j++) {
            double ref = (double)op_exact[i][j];
            double appro = (double)op_func[i][j];

            signal += ref * ref;
            double err = ref - appro;
            noise += err * err;
        }
    }

    if (noise == 0.0) {
      for (volatile int i = 0; i < 10000; i++);
     puts("Noise is 0");
       for (volatile int i = 0; i < 10000; i++);
       
     }
     putchar('\n');
    for (volatile int i = 0; i < 10000; i++);
     puts("Signal Val :");
     print_double_decimal(signal);
     for (volatile int i = 0; i < 10000; i++);
     putchar('\n');
     
    for (volatile int i = 0; i < 10000; i++);
     puts("Noise Val :");
     print_double_decimal(noise);
        for (volatile int i = 0; i < 10000; i++);
     
      putchar('\n');
 for (volatile int i = 0; i < 10000; i++);
  
}


void compute_signal_noise_2d(uint64_t exact[IMG_SIZE][IMG_SIZE], 
                             uint64_t approx[IMG_SIZE][IMG_SIZE]
                             ) 
                             {
    uint64_t signal = 0;
    uint32_t signal1 = 0;
    uint32_t signal2 = 0;
    uint64_t noise  = 0;
    uint32_t identical_count = 0; 
    for (int i = 0; i < IMG_SIZE; i++) {
        for (int j = 0; j < IMG_SIZE; j++) {
            signal += exact[i][j] * exact[i][j];         // Signal power
                
            int64_t diff = (int64_t)exact[i][j] - (int64_t)approx[i][j];
            if (diff == 0) {
                identical_count++;  // Increment if values are same
            }
            noise += (uint64_t)(diff * diff);// Noise power
        }
    }
    
    signal1 = signal & 0xFFFFFFFF;
    signal2 = (signal>>32) & 0xFFFFFFFF;    
    
    for (volatile int i = 0; i < 10000; i++);
     puts("same count :");
     puthex(identical_count);
     for (volatile int i = 0; i < 10000; i++);
     putchar('\n');
 for (volatile int i = 0; i < 10000; i++);
     puts("Signal Val :");
     puthex(signal);
     puts("Signal Val1 :");
     puthex(signal1);     
     puts("Signal Val2 :");
     puthex(signal2);     
     for (volatile int i = 0; i < 10000; i++);
     putchar('\n');
     
    for (volatile int i = 0; i < 10000; i++);
     puts("Noise Val :");
     puthex(noise);
        for (volatile int i = 0; i < 10000; i++);
     
      putchar('\n');
 for (volatile int i = 0; i < 10000; i++);
  
}
void print_double_decimal(double value) {
    uint32_t int_part = (uint32_t)value;
    uint32_t frac_part = (uint32_t)((value - int_part) * 10000);  // 4 decimal digits

    // Print integer part
    if (int_part == 0) {
        putchar('0');
    } else {
        char buffer[10];
        int i = 0;
        while (int_part > 0) {
            buffer[i++] = '0' + (int_part % 10);
            int_part /= 10;
        }
        while (i--) putchar(buffer[i]);
    }

    putchar('.');

    // Print fractional part with leading zeros
    char frac_buffer[5];
    for (int i = 3; i >= 0; --i) {
        frac_buffer[i] = '0' + (frac_part % 10);
        frac_part /= 10;
    }
    for (int i = 0; i < 4; i++) {
        putchar(frac_buffer[i]);
    }

    putchar('\n');
}

int main(void) {
    install_exception_handler(UART_IRQ_NUM, &test_uart_irq_handler);
    uart_enable_rx_int();
    timer_init();
    timer_enable(5000000);

    uint64_t last_elapsed_time = get_elapsed_time();
    set_outputs(GPIO_OUT, 0x10);
    srand(last_elapsed_time);
    
     
    
    gaussian_filter_exact();
    
    pcount_enable(0);
    pcount_reset();
    
    
    

    
    pcount_enable(1);

    gaussian_filter_approx();

    pcount_enable(0);
    
    compute_signal_noise_2d(op_exact, op_func);
    
    
    
    uint64_t sum = 0;
    for (unsigned int i = 0; i < IMG_SIZE; i++) {
        for (unsigned int j = 0; j < IMG_SIZE; j++) {
            sum += op_func[i][j];
        }
    }
    
  //  for (uint32_t i = 0; i < IMG_SIZE ; i++) {
  //      for (uint32_t j = 0; j < IMG_SIZE ; j++) {
   //      for (volatile int i = 0; i < 10000; i++);
    //        puthex(op_func[i][j]);
  //           for (volatile int i = 0; i < 10000; i++);
     //       putchar(' ');
     //        for (volatile int i = 0; i < 10000; i++);
     //   }
    //    }

    putchar('\n');
    for (volatile int i = 0; i < 10000; i++);
    puthex(sum);
    for (volatile int i = 0; i < 10000; i++);
putchar('\n');
for (volatile int i = 0; i < 10000; i++);
    puts("Gaussian Image Filtering Results (50x50 image, 7x7 kernel)");
    for (volatile int i = 0; i < 10000; i++);
    putchar('\n');
    for (volatile int i = 0; i < 10000; i++);

    return 0;
}

